# Rust OMT 送信テスト

libomtライブラリを使用したOMT（Open Media Technology）送信テストのRust実装です。

## 特徴

- **マルチフォーマット対応**: UYVY、BGRA、NV12のビデオフォーマット
- **複数解像度**: 720pと1080pでのテスト
- **リアルタイム統計**: 帯域幅、フレーム数、ドロップ数の監視
- **強化されたエラーハンドリング**: OMTステータスコードの適切な解釈
- **カラフルなテストパターン**: UYVYのSMPTEカラーバー、BGRAのグラデーション
- **高精度タイミング**: ドリフト補正機能付きの正確なフレームレート制御

## プロジェクト構造

```
rust-omt/
├── Cargo.toml                    # Rustプロジェクト設定
├── build.rs                      # FFIバインディング用ビルドスクリプト
├── vendor/
│   ├── include/
│   │   └── libomt.h              # OMTライブラリのヘッダーファイル
│   └── macos/
│       ├── libomt.dylib          # OMT動的ライブラリ
│       └── libvmx.dylib          # VMX依存ライブラリ
└── src/
    ├── main.rs                   # メインテストスイート
    ├── debug.rs                  # デバッグ・診断ツール
    └── bindings.rs               # 生成されたFFIバインディング
```

## セットアップ

### 前提条件

1. macOSシステム
2. Rustツールチェーンのインストール
3. テスト用のOMT Monitorまたは互換性のあるレシーバー

### テストの実行

#### デバッグモード（初回実行時推奨）
```bash
DYLD_FALLBACK_LIBRARY_PATH=./vendor/macos cargo run --bin debug
```
詳細な出力とステップバイステップの診断を提供します。

#### 完全テストスイート
```bash
DYLD_FALLBACK_LIBRARY_PATH=./vendor/macos cargo run
```
すべてのフォーマットと解像度の組み合わせを実行します。

#### 特定フォーマットのテスト
```bash
# UYVY 720p30のみテスト
DYLD_FALLBACK_LIBRARY_PATH=./vendor/macos cargo run UYVY_720p30

# BGRA 1080p30のみテスト
DYLD_FALLBACK_LIBRARY_PATH=./vendor/macos cargo run BGRA_1080p30

# NV12 720p30のみテスト
DYLD_FALLBACK_LIBRARY_PATH=./vendor/macos cargo run NV12_720p30
```

利用可能なフォーマット:
- `UYVY_720p30` - UYVY 1280x720 @ 30fps
- `UYVY_1080p30` - UYVY 1920x1080 @ 30fps  
- `BGRA_720p30` - BGRA 1280x720 @ 30fps
- `BGRA_1080p30` - BGRA 1920x1080 @ 30fps
- `NV12_720p30` - NV12 1280x720 @ 30fps

## OMTステータスコードの理解

OMTライブラリは「エラー」のように見えるが、実際には情報提供のためのさまざまなステータスコードを返します：

- **0**: 完全な成功
- **12428, 19448, 29843, 39293**: フレームのキューイング/処理を示すステータスコード（致命的でない）
- **26984**: バッファオーバーフロー（リトライが必要）
- **-1**: 一般的なエラー（致命的）

ゼロでないステータスコードでもフレームは正常に送信されており、以下で確認できます：
1. バイト数とフレーム数の増加を示す統計
2. OMT Monitorでの受信成功
3. テストパターンの適切な表示

## テストパターン

### UYVYフォーマット
SMPTEカラーバーを生成：
- 白、黄、シアン、緑、マゼンタ、赤、青、黒

### BGRAフォーマット  
RGBグラデーションを生成：
- 青：左から右に増加
- 緑：上から下に増加
- 赤：両軸を組み合わせ

### NV12フォーマット
単色パターンを生成（現在は基本的な実装）

## トラブルシューティング

### レシーバー未接続
テストを開始する前に、OMT Monitorが実行されており、受信モードに設定されていることを確認してください。

### セグメンテーションフォルト
この問題は、バッファサイズの計算とデータ長設定の修正により解決されました。現在の実装はサポートされているすべてのフォーマットを適切に処理します。

### 高い「エラー」コード
これらはステータスコードであり、実際のエラーではない可能性があります。以下を確認してください：
1. 統計がフレーム/バイト数の増加を示している
2. OMT Monitorがビデオストリームを受信している
3. テストパターンが表示されている

### ビルド警告
型名に関する多数の警告は、自動生成されたFFIバインディングによるもので、安全に無視できます。

## ログファイル

デバッグ情報は以下に書き込まれます：
- `/tmp/omt-send-debug.log`（デバッグモード）
- `/tmp/omt-send.log`（メインテストスイート）

OMTライブラリの詳細な内部メッセージについては、これらのファイルを確認してください。